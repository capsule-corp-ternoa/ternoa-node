name: Run Ternoa Benchmarks Manual

on:
  workflow_dispatch:
    inputs:
      runtime:
        description: 'Runtime'
        required: true
        type: choice
        options:
        - alphanet
        - mainnet
        - chaosnet

env:
  CARGO_TERM_COLOR: always
  Runtime: ${{ github.event.inputs.runtime }}

jobs:
  start:
    runs-on: ubuntu-latest
    name: Start Build Machine
    steps:
    - name: Get SCW
      run: sudo curl -o /usr/local/bin/scw -L "https://github.com/scaleway/scaleway-cli/releases/download/v2.5.1/scaleway-cli_2.5.1_linux_amd64"

    - name: Allow executing file as program
      run: sudo chmod +x /usr/local/bin/scw

    - name: Init SCW
      run: scw init secret-key=${{ secrets.SW_CHAIN_REFERENCE_PROJ_SECRET_KEY }} install-autocomplete=false send-telemetry=true

    - name: Start Machine
      run: scw instance server start 704d19ea-2648-4594-8ef4-28bdd1321e65 --wait

  build:
    runs-on: ternoa-build-machine-0
    name: Build Ternoa Client
    needs: start
    steps:
    - uses: actions/checkout@v3

    - name: Setup Rust toolchain
      run: rustup show

    - name: Build the Ternoa client
      run: cargo build --release --features runtime-benchmarks

    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ternoa-binary
        path: ./target/release/ternoa

  generate-weights:
    runs-on: reference-machine
    name: Run benchmarks
    needs: build
    steps:
      - uses: actions/checkout@v3

      - name: Download Binary
        uses: actions/download-artifact@v3
        with:
          name: ternoa-binary

      - name: Change permission
        run: chmod u+x ternoa

      - name: Delete Binary Artifact
        uses: geekyeggo/delete-artifact@v1
        with:
          name: ternoa-binary

      - name: Create Folder for binary
        run: mkdir -p ./target/release

      - name: Move Binary
        run: cp ./ternoa ./target/release/ternoa

      - name: Run benchmarks
        run: ./scripts/benchmarks/"$Runtime"/run_benchmarks.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: generated-weights
          path: weights
        
  stop:
    runs-on: ubuntu-latest
    name: Stop Build Machine
    needs: build
    if: always()
    steps:
    - name: Get SCW
      run: sudo curl -o /usr/local/bin/scw -L "https://github.com/scaleway/scaleway-cli/releases/download/v2.5.1/scaleway-cli_2.5.1_linux_amd64"

    - name: Allow executing file as program
      run: sudo chmod +x /usr/local/bin/scw

    - name: Init SCW
      run: scw init secret-key=${{ secrets.SW_CHAIN_REFERENCE_PROJ_SECRET_KEY }} install-autocomplete=false send-telemetry=true

    - name: Stop Machine
      run: scw instance server stop 704d19ea-2648-4594-8ef4-28bdd1321e65